<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Suporte T√©cnico - Cloud Sync v9.1</title>
    <style>
        :root {
            --bg-body: #121212; --bg-container: #1e1e1e; --bg-input: #2d2d2d;
            --text-primary: #e0e0e0; --text-secondary: #b0b0b0;
            --accent-blue: #3f8cf5; --accent-green: #2eb85c; --accent-red: #e55353;
            --border-color: #333333;
        }

        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-body); color: var(--text-primary); display: flex; justify-content: center; padding: 20px; align-items: flex-start; min-height: 100vh; margin: 0; box-sizing: border-box; }
        .container { background: var(--bg-container); padding: 25px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.5); width: 100%; max-width: 600px; border: 1px solid var(--border-color); }
        
        h2 { color: var(--accent-blue); margin: 0 0 15px 0; font-size: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        label { display: block; margin-top: 12px; font-weight: 600; color: var(--text-secondary); font-size: 13px; }
        
        input, textarea, select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; font-size: 14px; background: var(--bg-input); color: var(--text-primary); }
        
        .checklist-container { background: #252525; padding: 15px; border-radius: 8px; margin-top: 10px; border: 1px dashed var(--accent-blue); display: none; }
        .checklist-title { font-size: 12px; font-weight: bold; color: var(--accent-blue); margin-bottom: 10px; text-transform: uppercase; }
        .check-item { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 13px; cursor: pointer; }
        .check-item input[type="checkbox"] { width: auto; margin: 0; cursor: pointer; }

        .btn-group { display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-top: 25px; }
        button { padding: 12px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; transition: 0.3s; }
        .btn-clear, .btn-back, .btn-copy { background-color: var(--accent-blue); color: white; }
        .btn-login { background-color: var(--accent-blue); color: white; width: 100%; margin-top: 20px; }
        
        .btn-back { width: 100%; margin-top: 5px; margin-bottom: 20px; }
        .btn-settings { background-color: transparent; color: var(--accent-blue); border: 1px solid var(--accent-blue); font-size: 11px; padding: 5px 8px; margin-left: 5px; }
        .btn-logout { background-color: transparent; color: var(--accent-red); border: 1px solid var(--accent-red); font-size: 11px; padding: 5px 8px; }
        .btn-add { background: var(--accent-green); color: white; width: 100%; margin-top: 10px; }
        
        .template-item { display: flex; justify-content: space-between; align-items: center; background: #252525; padding: 10px; margin-bottom: 8px; border-radius: 6px; border: 1px solid var(--border-color); font-size: 13px; }
        .actions { display: flex; gap: 15px; }
        .btn-action-edit { color: var(--accent-blue); cursor: pointer; font-weight: bold; border: none; background: none; }
        .btn-action-del { color: var(--accent-red); cursor: pointer; font-weight: bold; border: none; background: none; }

        /* Controles de Tela */
        #loginScreen, #appScreen, #mainScreen, #settingsScreen { display: none; }
        #statusMsg { text-align: center; margin-top: 10px; font-size: 12px; font-weight: bold; height: 15px; }
    </style>
</head>
<body>

<div class="container" id="loginScreen" style="display: block;">
    <h2 style="justify-content: center; border-bottom: none;">üîí Acesso Restrito</h2>
    <p style="text-align: center; color: var(--text-secondary); font-size: 13px; margin-top: -10px;">Entre com suas credenciais do Firebase</p>
    
    <label>E-mail</label>
    <input type="email" id="emailInput" placeholder="seu@email.com">
    
    <label>Senha</label>
    <input type="password" id="senhaInput" placeholder="Sua senha secreta">
    
    <button class="btn-login" onclick="fazerLogin()">Entrar no Sistema</button>
    <div id="loginMsg" style="text-align: center; margin-top: 15px; font-size: 13px; color: var(--accent-red);"></div>
</div>

<div class="container" id="appScreen">
    
    <div id="mainScreen">
        <h2>
            Scripts Gerador
            <div>
                <button class="btn-logout" onclick="fazerLogout()">Sair</button>
                <button class="btn-settings" onclick="showSettings()">‚öô Configura√ß√µes</button>
            </div>
        </h2>
        
        <div style="display:flex; gap:8px;">
            <div style="width:80px;"><label>Trat.</label><select id="tratamento"><option>Sr.</option><option>Sra.</option></select></div>
            <div style="flex-grow:1;"><label>Usu√°rio</label><input type="text" id="usuario" placeholder="Nome do solicitante"></div>
        </div>
        
        <label>Ocorr√™ncia / Chamado</label><input type="text" id="problema" placeholder="Ex: Problema de Hardware">
        <label>Modelo R√°pido</label><select id="templateSelect" onchange="carregarCamposDinamicos()"><option value="">-- Carregando da Nuvem... --</option></select>
        
        <div id="areaDinamica" class="checklist-container">
            <div class="checklist-title">Testes e Valida√ß√µes</div><div id="listaTestes"></div>
            <div class="checklist-title" style="margin-top:15px;">Resolu√ß√£o Aplicada</div><div id="listaResolucao"></div>
        </div>
        
        <label>Procedimento T√©cnico Final</label>
        <textarea id="procedimento" rows="10" placeholder="Selecione um modelo r√°pido para gerar a estrutura..."></textarea>
        
        <div id="statusMsg"></div>
        <div class="btn-group">
            <button class="btn-clear" onclick="limparCampos()">Limpar</button>
            <button id="btnCopy" class="btn-copy" onclick="copiarTexto()">Copiar Script</button>
        </div>
    </div>

    <div id="settingsScreen">
        <h2>Gerenciar Nuvem ‚òÅÔ∏è</h2>
        <button class="btn-back" onclick="showMain()">‚Üê Voltar ao In√≠cio</button>
        
        <div style="background: #252525; padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
            <label>T√≠tulo do Modelo</label><input type="text" id="newLabel">
            <label>T√≥picos de Teste (Separe por PONTO .)</label><textarea id="newTestes" rows="2" placeholder="Ex: Teste 1. Teste 2"></textarea>
            <label>Op√ß√µes de Resolu√ß√£o (Separe por PONTO .)</label><textarea id="newResolucoes" rows="2" placeholder="Ex: Solu√ß√£o 1. Solu√ß√£o 2"></textarea>
            <button id="btnSaveTemplate" class="btn-add" onclick="addTemplate()">Salvar na Nuvem</button>
        </div>
        
        <div style="margin-top: 20px;"><h3 style="font-size: 14px; color: var(--text-secondary);">Modelos Ativos na Nuvem:</h3><div id="templateList"></div></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyByHEnrOw-b188DfXS-qE2guwVMujdkJ_0",
      authDomain: "gerador-de-chamados.firebaseapp.com",
      projectId: "gerador-de-chamados",
      storageBucket: "gerador-de-chamados.firebasestorage.app",
      messagingSenderId: "313628427225",
      appId: "1:313628427225:web:b1d29ef4bd3934abd44fc8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let templates = {};
    let editingKey = null;
    let currentUser = null;

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appScreen').style.display = 'block';
            document.getElementById('mainScreen').style.display = 'block';
            await carregarDaNuvem(); 
        } else {
            currentUser = null;
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('appScreen').style.display = 'none';
        }
    });

    window.fazerLogin = function() {
        const email = document.getElementById('emailInput').value;
        const senha = document.getElementById('senhaInput').value;
        const msg = document.getElementById('loginMsg');
        msg.innerText = "Autenticando...";
        msg.style.color = "var(--text-secondary)";
        
        signInWithEmailAndPassword(auth, email, senha)
            .catch((error) => {
                msg.style.color = "var(--accent-red)";
                msg.innerText = "Erro: E-mail ou senha incorretos.";
            });
    }

    window.fazerLogout = function() {
        signOut(auth).then(() => {
            document.getElementById('emailInput').value = '';
            document.getElementById('senhaInput').value = '';
            document.getElementById('loginMsg').innerText = '';
        });
    }

    async function carregarDaNuvem() {
        if(!currentUser) return;
        document.getElementById('templateSelect').innerHTML = '<option value="">Carregando da nuvem...</option>';
        try {
            const docRef = doc(db, "userData", currentUser.uid);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists() && docSnap.data().templates) {
                templates = docSnap.data().templates;
            } else {
                templates = {}; 
            }
            renderTemplates();
        } catch(e) {
            alert("Erro ao conectar no banco de dados.");
        }
    }

    async function salvarNaNuvem() {
        if(!currentUser) return;
        const btn = document.getElementById('btnSaveTemplate');
        const textOriginal = btn ? btn.innerText : "";
        if(btn) btn.innerText = "Salvando...";
        
        try {
            const docRef = doc(db, "userData", currentUser.uid);
            await setDoc(docRef, { templates: templates }, { merge: true });
            if(btn) btn.innerText = textOriginal;
        } catch(e) {
            alert("Erro ao salvar na nuvem.");
            if(btn) btn.innerText = textOriginal;
        }
    }

    window.showSettings = function() { document.getElementById('mainScreen').style.display='none'; document.getElementById('settingsScreen').style.display='block'; }
    window.showMain = function() { document.getElementById('mainScreen').style.display='block'; document.getElementById('settingsScreen').style.display='none'; window.cancelEdit(); }

    function renderTemplates() {
        const select = document.getElementById('templateSelect');
        const list = document.getElementById('templateList');
        select.innerHTML = '<option value="">-- Selecionar Modelo --</option>';
        list.innerHTML = '';
        for (const label in templates) {
            const opt = document.createElement('option'); opt.value = label; opt.innerText = label; select.appendChild(opt);
            const item = document.createElement('div'); item.className = 'template-item';
            item.innerHTML = `<span>${label}</span><div class="actions"><button class="btn-action-edit" onclick="editTemplate('${label}')">Editar</button><button class="btn-action-del" onclick="deleteTemplate('${label}')">Excluir</button></div>`;
            list.appendChild(item);
        }
    }

    window.carregarCamposDinamicos = function() {
        const sel = document.getElementById('templateSelect').value;
        const area = document.getElementById('areaDinamica');
        if(!sel) { area.style.display = 'none'; return; }
        area.style.display = 'block';
        document.getElementById('listaTestes').innerHTML = templates[sel].testes.map(t => `<label class="check-item"><input type="checkbox" class="check-test" value="${t}" onchange="montarProcedimento()"> ${t}</label>`).join('');
        document.getElementById('listaResolucao').innerHTML = templates[sel].resolucoes.map(r => `<label class="check-item"><input type="checkbox" class="check-res" value="${r}" onchange="montarProcedimento()"> ${r}</label>`).join('');
        window.montarProcedimento();
    }

    window.montarProcedimento = function() {
        const tMarcados = Array.from(document.querySelectorAll('.check-test:checked')).map(c => c.value);
        const rMarcadas = Array.from(document.querySelectorAll('.check-res:checked')).map(c => c.value);
        let texto = "";
        
        if(tMarcados.length > 0) { texto += "TESTES E VALIDA√á√ïES:\n" + tMarcados.map(t => " ‚Ä¢ " + t).join("\n"); }
        if(rMarcadas.length > 0) {
            if(texto !== "") texto += "\n\n"; 
            texto += "RESOLU√á√ÉO APLICADA:\n" + rMarcadas.map(r => " ‚Ä¢ " + r).join("\n");
        }
        document.getElementById('procedimento').value = texto;
    }

    window.addTemplate = async function() {
        const label = document.getElementById('newLabel').value.trim();
        const testes = document.getElementById('newTestes').value.split('.').map(s => s.trim()).filter(s => s);
        const res = document.getElementById('newResolucoes').value.split('.').map(s => s.trim()).filter(s => s);
        if (label) {
            if (editingKey && editingKey !== label) delete templates[editingKey];
            templates[label] = { testes: testes, resolucoes: res };
            renderTemplates(); 
            await salvarNaNuvem(); 
            window.cancelEdit();
        }
    }

    window.editTemplate = function(label) {
        editingKey = label;
        const data = templates[label];
        document.getElementById('newLabel').value = label;
        document.getElementById('newTestes').value = data.testes.join('. ');
        document.getElementById('newResolucoes').value = data.resolucoes.join('. ');
        const btn = document.getElementById('btnSaveTemplate');
        btn.innerText = "Atualizar na Nuvem"; btn.style.backgroundColor = "var(--accent-blue)";
        window.scrollTo(0,0);
    }

    window.cancelEdit = function() {
        editingKey = null;
        document.getElementById('newLabel').value = ''; document.getElementById('newTestes').value = ''; document.getElementById('newResolucoes').value = '';
        const btn = document.getElementById('btnSaveTemplate');
        if(btn) { btn.innerText = "Salvar na Nuvem"; btn.style.backgroundColor = "var(--accent-green)"; }
    }

    window.deleteTemplate = async function(l) { 
        if(confirm(`Deseja deletar permanentemente "${l}" da nuvem?`)) { 
            delete templates[l]; 
            renderTemplates(); 
            await salvarNaNuvem(); 
        } 
    }

    window.copiarTexto = function() {
        const trat = document.getElementById('tratamento').value;
        const user = document.getElementById('usuario').value || "...";
        const prob = document.getElementById('problema').value || "...";
        const proc = document.getElementById('procedimento').value || "...";
        
        const script = `Prezado(a) ${user},\n\nComunicamos a conclus√£o do atendimento t√©cnico referente √† solicita√ß√£o: "${prob}".\n\nA seguir, apresentamos o relat√≥rio das a√ß√µes executadas:\n\n${proc}\n\nDestacamos que o problema foi solucionado com sucesso, e o pleno funcionamento dos recursos foi testado e aprovado pelo(a) ${trat} ${user} no ato do atendimento.\n\nDiante da resolu√ß√£o, este chamado encontra-se formalmente encerrado em nosso sistema. Em caso de reincid√™ncia ou para novas solicita√ß√µes, orientamos a abertura de um novo chamado, garantindo assim o registro e a conformidade do suporte prestado.\n\nAtenciosamente,\nEquipe de Suporte T√©cnico.`;
        
        navigator.clipboard.writeText(script).then(() => {
            const btn = document.getElementById('btnCopy'); btn.innerText = "Copiado!";
            setTimeout(() => { btn.innerText = "Copiar Script"; }, 2000);
        });
    }

    window.limparCampos = function() {
        document.getElementById('usuario').value = ''; document.getElementById('problema').value = '';
        document.getElementById('procedimento').value = ''; document.getElementById('templateSelect').value = '';
        document.getElementById('areaDinamica').style.display = 'none';
    }

    document.addEventListener('contextmenu', e => e.preventDefault());

</script>
</body>
</html>